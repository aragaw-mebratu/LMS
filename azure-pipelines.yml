trigger:
- master

variables:
  IMAGE_NAME: aragawmebratu/lms
  IMAGE_TAG: $(Build.BuildId)

stages:
- stage: BuildAndPublish
  displayName: Build, Push, and Publish Artifacts
  jobs:
  - job: Docker
    displayName: Docker Build Job
    pool:
      name: SelfHosted   # Windows self-hosted agent

    steps:
    - checkout: self

    # ğŸ” Login to Docker Hub
    - task: Docker@2
      displayName: Docker Hub Login
      inputs:
        command: login
        containerRegistry: DockerHub

    # ğŸ“ Generate .env dynamically (secure secrets from pipeline variables)
    - task: Bash@3
      displayName: Generate backend.env
      inputs:
        targetType: inline
        script: |
          ARTIFACT_DIR=$(wslpath "$(Build.ArtifactStagingDirectory)")
          mkdir -p "$ARTIFACT_DIR"
          ENV_FILE="$ARTIFACT_DIR/backend.env"

          cat <<EOF > "$ENV_FILE"
          MAILGUN_API_KEY=$(MAILGUN_API_KEY)
          MAILERSEND_API_TOKEN=$(MAILERSEND_API_TOKEN)
          MAILGUN_SENDER_DOMAIN=$(MAILGUN_SENDER_DOMAIN)
          FROM_EMAIL=$(FROM_EMAIL)
          DJANGO_DEBUG=$(DJANGO_DEBUG)
          DJANGO_SECRET_KEY=$(DJANGO_SECRET_KEY)
          DJANGO_ALLOWED_HOSTS=$(DJANGO_ALLOWED_HOSTS)
          EOF

          echo "Generated .env file:"
          cat "$ENV_FILE"

    # ğŸ³ Build & Push Docker Image
    - task: Docker@2
      displayName: Build & Push Backend Image
      inputs:
        command: buildAndPush
        repository: $(IMAGE_NAME)
        dockerfile: Dockerfile.backend
        tags: |
          $(IMAGE_TAG)
          latest

    # ğŸ“ Inject image tag into docker-compose.yml (WSL-safe)
    - task: Bash@3
      displayName: Inject image tag into docker-compose.yml
      inputs:
        targetType: inline
        script: |
          echo "Injecting IMAGE_TAG=$(IMAGE_TAG)"

          # Convert Windows paths â†’ WSL paths
          SRC_COMPOSE=$(wslpath "$(Build.SourcesDirectory)/docker-compose.yml")
          ARTIFACT_DIR=$(wslpath "$(Build.ArtifactStagingDirectory)")
          OUT_COMPOSE="$ARTIFACT_DIR/docker-compose.yml"

          echo "Source compose: $SRC_COMPOSE"
          echo "Artifact compose: $OUT_COMPOSE"

          mkdir -p "$ARTIFACT_DIR"

          sed "s|\${IMAGE_TAG}|$(IMAGE_TAG)|g" "$SRC_COMPOSE" > "$OUT_COMPOSE"

          echo "Updated docker-compose.yml:"
          cat "$OUT_COMPOSE"

    # ğŸ“¦ Publish docker-compose.yml and backend.env as artifacts
    - task: PublishBuildArtifacts@1
      displayName: Publish docker-compose and .env artifacts
      inputs:
        PathtoPublish: $(Build.ArtifactStagingDirectory)
        ArtifactName: docker-compose
        publishLocation: Container
