trigger:
- master

variables:
  IMAGE_NAME: aragawmebratu/lms
  IMAGE_TAG: $(Build.BuildId)

stages:
- stage: BuildAndPublish
  displayName: Build, Push, and Publish Artifacts
  jobs:
  - job: Docker
    displayName: Docker Build Job
    pool:
      name: SelfHosted   # Windows self-hosted agent

    steps:
    - checkout: self

    # ðŸ” Login to Docker Hub
    - task: Docker@2
      displayName: Docker Hub Login
      inputs:
        command: login
        containerRegistry: DockerHub

    # ðŸ³ Build & Push Docker Image
    - task: Docker@2
      displayName: Build & Push Backend Image
      inputs:
        command: buildAndPush
        repository: $(IMAGE_NAME)
        dockerfile: Dockerfile.backend
        tags: |
          $(IMAGE_TAG)
          latest

    # ðŸ“ Inject image tag into docker-compose.yml (WSL-safe)
    - task: Bash@3
      displayName: Inject image tag into docker-compose.yml
      inputs:
        targetType: inline
        script: |
          echo "Injecting IMAGE_TAG=$(IMAGE_TAG)"

          # Convert Windows paths â†’ WSL paths
          SRC_COMPOSE=$(wslpath "$(Build.SourcesDirectory)/docker-compose.yml")
          ARTIFACT_DIR=$(wslpath "$(Build.ArtifactStagingDirectory)")
          OUT_COMPOSE="$ARTIFACT_DIR/docker-compose.yml"

          echo "Source compose: $SRC_COMPOSE"
          echo "Artifact compose: $OUT_COMPOSE"

          mkdir -p "$ARTIFACT_DIR"

          sed "s|\${IMAGE_TAG}|$(IMAGE_TAG)|g" "$SRC_COMPOSE" > "$OUT_COMPOSE"

          echo "Updated docker-compose.yml:"
          cat "$OUT_COMPOSE"

    # ðŸ“¦ Publish docker-compose.yml as artifact
    - task: PublishBuildArtifacts@1
      displayName: Publish docker-compose artifact
      inputs:
        PathtoPublish: $(Build.ArtifactStagingDirectory)/docker-compose.yml
        ArtifactName: docker-compose
        publishLocation: Container
