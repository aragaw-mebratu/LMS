trigger:
- master

variables:
  IMAGE_NAME: aragawmebratu/lms
  IMAGE_TAG: $(Build.BuildId)

stages:
- stage: BuildAndPublish
  displayName: Build & Push Docker Image
  jobs:
  - job: Docker
    displayName: Docker Build Job
    pool:
      name: SelfHosted   # âœ… Linux agent (recommended)

    steps:
    - checkout: self

    # ðŸ” Login to Docker Hub
    - task: Docker@2
      displayName: Docker Hub Login
      inputs:
        command: login
        containerRegistry: DockerHub   # service connection name

    # ðŸ³ Build & Push Docker Image
    - task: Docker@2
      displayName: Build & Push Backend Image
      inputs:
        command: buildAndPush
        repository: $(IMAGE_NAME)
        dockerfile: Dockerfile.backend
        tags: |
          $(IMAGE_TAG)

    # ðŸ“ Update docker-compose.yml (BASH â€” no PowerShell!)
    - task: Bash@3
      displayName: Inject image tag into docker-compose.yml
      inputs:
        targetType: inline
        script: |
          echo "Injecting IMAGE_TAG=$(IMAGE_TAG)"

          COMPOSE_SRC="$(Build.SourcesDirectory)/docker-compose.yml"
          COMPOSE_OUT="$(Build.ArtifactStagingDirectory)/docker-compose.yml"

          echo "Source: $COMPOSE_SRC"
          echo "Output: $COMPOSE_OUT"

          sed "s|\${IMAGE_TAG}|$(IMAGE_TAG)|g" "$COMPOSE_SRC" > "$COMPOSE_OUT"

    # ðŸ“¦ Publish docker-compose.yml
    - task: PublishBuildArtifacts@1
      displayName: Publish docker-compose artifact
      inputs:
        PathtoPublish: $(Build.ArtifactStagingDirectory)/docker-compose.yml
        ArtifactName: docker-compose
        publishLocation: Container
