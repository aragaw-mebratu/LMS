trigger:
- master

variables:
  BACKEND_IMAGE: aragawmebratu/lms-backend
  FRONTEND_IMAGE: aragawmebratu/lms-frontend
  IMAGE_TAG: $(Build.BuildId)

stages:
- stage: BuildAndPublish
  displayName: Build, Push, and Publish Artifacts
  jobs:
  - job: Docker
    displayName: Docker Build Job
    pool:
      name: SelfHosted

    steps:
    - checkout: self

    # ðŸ” Docker Hub Login
    - task: Docker@2
      displayName: Docker Hub Login
      inputs:
        command: login
        containerRegistry: DockerHub

    # ðŸ” Generate backend.env safely
    - task: Bash@3
      displayName: Generate backend.env
      inputs:
        targetType: inline
        script: |
          set -e

          ARTIFACT_DIR=$(wslpath "$(Build.ArtifactStagingDirectory)")
          mkdir -p "$ARTIFACT_DIR"

          ENV_FILE="$ARTIFACT_DIR/backend.env"

          echo "MAILGUN_API_KEY=$(MAILGUN_API_KEY)" >  "$ENV_FILE"
          echo "MAILERSEND_API_TOKEN=$(MAILERSEND_API_TOKEN)" >> "$ENV_FILE"
          echo "MAILGUN_SENDER_DOMAIN=$(MAILGUN_SENDER_DOMAIN)" >> "$ENV_FILE"
          echo "FROM_EMAIL=$(FROM_EMAIL)" >> "$ENV_FILE"
          echo "DJANGO_DEBUG=$(DJANGO_DEBUG)" >> "$ENV_FILE"
          echo "DJANGO_SECRET_KEY=$(DJANGO_SECRET_KEY)" >> "$ENV_FILE"
          echo "DJANGO_ALLOWED_HOSTS=$(DJANGO_ALLOWED_HOSTS)" >> "$ENV_FILE"

          echo "backend.env generated"

    # ðŸ³ Backend image
    - task: Docker@2
      displayName: Build & Push Backend Image
      inputs:
        command: buildAndPush
        repository: $(BACKEND_IMAGE)
        dockerfile: Dockerfile.backend
        tags: |
          $(IMAGE_TAG)
          latest

    # ðŸ³ Frontend image
    - task: Docker@2
      displayName: Build & Push Frontend Image
      inputs:
        command: buildAndPush
        repository: $(FRONTEND_IMAGE)
        dockerfile: Dockerfile.frontend
        tags: |
          $(IMAGE_TAG)
          latest

    # ðŸ“ Inject tags into docker-compose.yml
    - task: Bash@3
      displayName: Inject image tags
      inputs:
        targetType: inline
        script: |
          SRC=$(wslpath "$(Build.SourcesDirectory)/docker-compose.yml")
          OUT_DIR=$(wslpath "$(Build.ArtifactStagingDirectory)")
          OUT="$OUT_DIR/docker-compose.yml"

          mkdir -p "$OUT_DIR"

          sed -e "s|\${BACKEND_IMAGE_TAG}|$(IMAGE_TAG)|g" \
              -e "s|\${FRONTEND_IMAGE_TAG}|$(IMAGE_TAG)|g" \
              "$SRC" > "$OUT"

    # ðŸ“¦ Publish artifacts
    - task: PublishBuildArtifacts@1
      displayName: Publish deployment artifacts
      inputs:
        PathtoPublish: $(Build.ArtifactStagingDirectory)
        ArtifactName: deployment
        publishLocation: Container
